name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_call:  # Allow this workflow to be called by other workflows

jobs:
  # PHP Application Tests
  php-tests:
    name: PHP Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: openentity_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, redis
          coverage: none

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Install PHP Dependencies
        env:
          BROADCAST_DRIVER: log
          REVERB_APP_ID: test
          REVERB_APP_KEY: test
          REVERB_APP_SECRET: test
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install Node Dependencies
        run: npm ci

      - name: Build Assets
        run: npm run build

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Run Tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: openentity_test
          DB_USERNAME: root
          DB_PASSWORD: password
          REDIS_HOST: 127.0.0.1
          QUEUE_CONNECTION: sync
        run: php artisan test

  # Docker Compose Validation
  docker-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config -q

      - name: Validate docker-compose.native-ollama.yml
        run: docker compose -f docker-compose.yml -f docker-compose.native-ollama.yml config -q

      - name: Validate docker-compose.gpu.yml (if exists)
        run: |
          if [ -f docker-compose.gpu.yml ]; then
            docker compose -f docker-compose.yml -f docker-compose.gpu.yml config -q
          fi

  # Script Syntax Validation
  script-validation:
    name: Script Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Bash syntax
        run: bash -n setup.sh

      - name: Check for shellcheck (optional)
        continue-on-error: true
        run: |
          if command -v shellcheck &> /dev/null; then
            shellcheck setup.sh
          else
            echo "shellcheck not installed, skipping"
          fi

      - name: Validate PowerShell syntax
        shell: pwsh
        run: |
          $tokens = $null
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile(
            "$PWD/setup.ps1",
            [ref]$tokens,
            [ref]$errors
          )
          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "PowerShell syntax OK"
